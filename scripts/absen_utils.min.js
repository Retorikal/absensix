function report(e,t=!1,n="info",o=!1){procMsg="ab¢6: "+e,console.log(procMsg),t||$.notify({message:procMsg},{type:n,placement:{align:"center"}}),o&&new Notification("ab¢6 Auto-attendance",{body:e,icon:"/favicon.ico"})}function parseTime(e){let t=new Date,[n,o]=e.split(":");return t.setHours(n),t.setMinutes(o),t.setSeconds("00"),t}function getTodayCourses(e=!1){let t=document.getElementsByTagName("table")[0],n=t.getElementsByClassName("bg-info")[0],o=[];if(e&&(n=t.getElementsByTagName("td")[0]),null==n)throw"No active date on calendar.";let s=n.getElementsByClassName("linkpertemuan");for(let e=0;e<s.length;e++){course=[];let t=s[e].innerText.split(" ")[0],n=parseTime(t.split("-")[0]),a=parseTime(t.split("-")[1]),r=s[e].getAttribute("data-url").split("?")[0],i=s[e].getAttribute("data-kuliah").match(/^(\S+)\s(.*)/).slice(1),u=i[0],d=i[1];course.push(n),course.push(a),course.push(r),course.push(u),course.push(d),course.push(null),o.push(course)}if(o==[])throw"No course found";return o}function getHTMLtxt(e,t){var n=new XMLHttpRequest;n.onreadystatechange=function(){4==this.readyState&&200==this.status&&t("<div>"+this.responseText+"</div>")},n.open("GET",e,!0),n.send()}function markPresent(e){var t=e[2],n=function(n){var o=$.parseHTML(n)[0].getElementsByTagName("form")[0],s=(new Date).getTime(),a=e[1].getTime();if(null==o)s>a+60*end_offset*1e3?(e[5]=3,report(e[3]+": Attendance probably already ended. Sorry.",!1,"danger",!0)):(e[5]=1,report(e[3]+": Attendance not open",!1,"warning"));else if(action_string=o.textContent.trim(),"Tandai Hadir"==action_string){let n=o.getElementsByTagName("input")[1],s=new XMLHttpRequest,a="";s.open("POST",t,!0),s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a+=encodeURI("form[hadir]")+"=&",a+=encodeURI("form[returnTo]")+"="+encodeURIComponent(t)+"&",a+=encodeURI("form[_token]")+"="+encodeURIComponent(n.getAttribute("value")),s.onreadystatechange=function(){4==this.readyState&&200==this.status?-1!=this.responseText.search("Tandai Tidak Hadir")&&(e[5]=0,report(e[3]+": Attendance successful",!1,"success",!0)):200==this.status||(404==this.status?(e[5]=-1,report(e[3]+": A not found error has occured. Please reload the page.",!1,"danger",!0)):(e[5]=-1,report(e[3]+": An unknown error has occured. Please reload the page.",!1,"danger",!0)))},s.send(a)}else-1!=n.search("Tandai Tidak Hadir")?(e[5]=2,report(e[3]+": Already attended",!1,"info",!0)):(e[5]=-1,report(e[3]+": An unknown error has occured. Please reload the page.",!1,"danger",!0))},o=function(){let s=setTimeout(()=>{-1!=e[5]&&1!=e[5]||(getHTMLtxt(t,n),o()),timeouts.splice(timeouts.indexOf(s),1)},60*repeat_delay*1e3);timeouts.push(s)};report(e[3]+": "+e[4]+" now active!",!0,"info",!0),getHTMLtxt(t,n),o()}function untilEvent(e){var t=(new Date).getTime(),n=e[0].getTime(),o=e[1].getTime();return[n-t+6e4*start_offset,o-t+6e4*end_offset]}function main(e){for(let t=0;t<e.length;t++)if(t_diff=untilEvent(e[t]),t_diff[0]>0){report(e[t][3]+": Scheduled attendance",!1);let n=setTimeout(()=>{markPresent(e[t]),timeouts.splice(timeouts.indexOf(n),1)},t_diff[0]);timeouts.push(n)}else t_diff[0]<=0&&t_diff[1]>=0?(report("Attending "+e[t][3],!1,"info"),markPresent(e[t])):report("Skipping "+e[t][3],!0,"info");var t=new Date,n=new Date;n.setHours(0,15,0,0),n.setDate(n.getDate()+1);let o=setTimeout(()=>{location.reload()},n.getTime()-t.getTime());timeouts.push(o)}chrome.runtime.onMessage.addListener(function(e,t,n){if(!t.tab){report("Config updated.",!1,"info",!0),start_offset=e[0],end_offset=e[1],repeat_delay=e[2];for(var o=0;o<timeouts.length;o++)clearTimeout(timeouts[o]);timeouts=[],main(courses)}}),report("Auto-attendance has been loaded.",!1,"info",!0),report("Due to login timeout issues, try logging out and in again before leaving this tab open. This will be addressed soon, so check for updates.",!1,"warning",!1),start_offset=1,end_offset=5,repeat_delay=5,timeouts=[],courses=[];try{courses=getTodayCourses()}catch{report("There is no active date today.")}chrome.storage.local.get({start_offset:1,end_offset:5,repeat_delay:5},function(e){start_offset=e.start_offset,end_offset=e.end_offset,repeat_delay=e.repeat_delay,main(courses)});