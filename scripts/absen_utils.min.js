function append_log(){chrome.storage.local.get({log_str:""},function(e){var t=e.log_str+log_str;chrome.storage.local.set({log_str:t},function(){log_str=""})})}function report(e,t=!1,o="info",n=!1){procMsg="ab¢6: "+e,console.log(procMsg),t||$.notify({message:procMsg},{type:o,placement:{align:"center"}}),n&&new Notification("ab¢6 Auto-attendance",{body:e,icon:"/favicon.ico"}),timestamp=(new Date).toLocaleString(),log_str+=`${timestamp} : ${e}\n`}function parseTime(e){let t=new Date,[o,n]=e.split(":");return t.setHours(o),t.setMinutes(n),t.setSeconds("00"),t}function getTodayCourses(e=!1){let t=document.getElementsByTagName("table")[0],o=t.getElementsByClassName("bg-info")[0],n=[];if(e&&(o=t.getElementsByTagName("td")[0]),null==o)throw"No active date on calendar.";let s=o.getElementsByClassName("linkpertemuan");for(let e=0;e<s.length;e++){course=[];let t=s[e].innerText.split(" ")[0],o=parseTime(t.split("-")[0]),a=parseTime(t.split("-")[1]),r=s[e].getAttribute("data-url").split("?")[0],i=s[e].getAttribute("data-kuliah").match(/^(\S+)\s(.*)/).slice(1),u=i[0],d=i[1];course.push(o),course.push(a),course.push(r),course.push(u),course.push(d),course.push(null),n.push(course)}if(n==[])throw"No course found";return n}function getHTMLtxt(e,t){var o=new XMLHttpRequest;o.onreadystatechange=function(){4==this.readyState&&200==this.status&&t("<div>"+this.responseText+"</div>")},o.open("GET",e,!0),o.send()}function markPresent(e){var t=e[2],o=function(o){var n=$.parseHTML(o)[0].getElementsByTagName("form")[0],s=(new Date).getTime(),a=e[1].getTime();if(null==n)s>a+60*end_offset*1e3?(e[5]=3,report(e[3]+": Attendance probably already ended. Sorry.",!1,"danger",!0)):(e[5]=1,report(e[3]+": Attendance not open",!1,"warning"));else if(action_string=n.textContent.trim(),"Tandai Hadir"==action_string){let o=n.getElementsByTagName("input")[1],s=new XMLHttpRequest,a="";s.open("POST",t,!0),s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a+=encodeURI("form[hadir]")+"=&",a+=encodeURI("form[returnTo]")+"="+encodeURIComponent(t)+"&",a+=encodeURI("form[_token]")+"="+encodeURIComponent(o.getAttribute("value")),s.onreadystatechange=function(){4==this.readyState&&200==this.status?-1!=this.responseText.search("Tandai Tidak Hadir")&&(e[5]=0,report(e[3]+": Attendance successful",!1,"success",!0)):200==this.status||(404==this.status?(e[5]=-1,report(e[3]+": A not found error has occured. Please reload the page.",!1,"danger",!0)):(e[5]=-1,report(e[3]+": An unknown error has occured. Please reload the page.",!1,"danger",!0)))},s.send(a)}else-1!=o.search("Tandai Tidak Hadir")?(e[5]=2,report(e[3]+": Already attended",!1,"info",!0)):(e[5]=-1,report(e[3]+": An unknown error has occured. Please reload the page.",!1,"danger",!0));append_log()},n=function(){let s=setTimeout(()=>{-1!=e[5]&&1!=e[5]||(getHTMLtxt(t,o),n()),timeouts.splice(timeouts.indexOf(s),1)},60*repeat_delay*1e3);timeouts.push(s)};report(e[3]+": "+e[4]+" now active!",!0,"info",!0),append_log(),getHTMLtxt(t,o),n()}function untilEvent(e){var t=(new Date).getTime(),o=e[0].getTime(),n=e[1].getTime();return[o-t+6e4*start_offset,n-t+6e4*end_offset]}function main(e){for(let t=0;t<e.length;t++)if(t_diff=untilEvent(e[t]),t_diff[0]>0){report(e[t][3]+": Scheduled attendance",!1);let o=setTimeout(()=>{markPresent(e[t]),timeouts.splice(timeouts.indexOf(o),1)},t_diff[0]);timeouts.push(o)}else t_diff[0]<=0&&t_diff[1]>=0?(report("Attending "+e[t][3],!1,"info"),markPresent(e[t])):report("Skipping "+e[t][3],!0,"info");var t=new Date,o=new Date;o.setHours(0,15,0,0),o.setDate(o.getDate()+1);let n=setTimeout(()=>{location.reload()},o.getTime()-t.getTime());timeouts.push(n),append_log()}chrome.runtime.onMessage.addListener(function(e,t,o){if(!t.tab){report("Config updated.",!1,"info",!0),start_offset=e[0],end_offset=e[1],repeat_delay=e[2];for(var n=0;n<timeouts.length;n++)clearTimeout(timeouts[n]);timeouts=[],main(courses)}}),start_offset=1,end_offset=5,repeat_delay=5,log_str="",timeouts=[],courses=[],report("Auto-attendance has been loaded.",!1,"info",!0),report("Due to login timeout issues, try logging out and in again before leaving this tab open. This will be addressed soon, so check for updates.",!1,"warning",!1);try{courses=getTodayCourses()}catch{report("There is no active date today.")}chrome.storage.local.get({start_offset:1,end_offset:5,repeat_delay:5},function(e){start_offset=e.start_offset,end_offset=e.end_offset,repeat_delay=e.repeat_delay,main(courses)});